clc
clear all
close all

%% Camera params

% Try to estimate camera parameters using the calibration function in
% Matlab; then compare the results with the one obtained


%% Load all mat files
data_dir = '../../experimental-data/Images for calibration/estimateCP method dataset/3 and 2 starting positions/';
kml_data_dir = '../../experimental-data/kml keypoints/';

% If previously created, delete the .mat file containing the worldPoints
% and the pixels
dinfo = dir([data_dir, 'world*', 'pixel*']);
for k = 1 : length(dinfo)
  thisfile = dinfo(k).name;
  delete(fullfile(dinfo(k).folder,thisfile));
end

dinfo = dir([data_dir, '*.mat']);
for k = 1 : length(dinfo)
  thisfile = dinfo(k).name;
  load(fullfile(dinfo(k).folder,thisfile));
end
%% Define keypoints, image coordinates

close all
imshow([data_dir,'test14.png'])
imagePoints        = [test_px_1(18).Position(1),test_px_1(18).Position(2); ...
    test_px_1(17).Position(1),test_px_1(17).Position(2); ...
    test_px_1(16).Position(1),test_px_1(16).Position(2); ...
    test_px_1(15).Position(1),test_px_1(15).Position(2); ...
    test_px_1(14).Position(1),test_px_1(14).Position(2); ...
    test_px_1(13).Position(1),test_px_1(13).Position(2); ...    
    test_px_1(12).Position(1),test_px_1(12).Position(2); ...
    test_px_1(11).Position(1),test_px_1(11).Position(2); ...
    test_px_1(10).Position(1),test_px_1(10).Position(2); ...
    test_px_1(9).Position(1),test_px_1(9).Position(2); ...
    test_px_1(8).Position(1),test_px_1(8).Position(2); ...
    test_px_1(7).Position(1),test_px_1(7).Position(2); ...
    test_px_1(6).Position(1),test_px_1(6).Position(2); ...
    test_px_1(5).Position(1),test_px_1(5).Position(2); ...
    test_px_1(4).Position(1),test_px_1(4).Position(2); ...
    test_px_1(3).Position(1),test_px_1(3).Position(2); ...    
    test_px_1(2).Position(1),test_px_1(2).Position(2); ...
    test_px_1(1).Position(1),test_px_1(1).Position(2); ...
    (test_px_1(5).Position(1)+test_px_1(6).Position(1))/2, ...
    (test_px_1(5).Position(2)+test_px_1(6).Position(2))/2; ...
    (test_px_1(18).Position(1)+test_px_1(16).Position(1))/2, ...
    (test_px_1(18).Position(2)+test_px_1(16).Position(2))/2; ...
    (test_px_1(17).Position(1)+test_px_1(15).Position(1))/2, ...
    (test_px_1(17).Position(2)+test_px_1(15).Position(2))/2; ...
    (test_px_1(16).Position(1)+test_px_1(15).Position(1))/2, ...
    (test_px_1(16).Position(2)+test_px_1(15).Position(2))/2; ...
    (test_px_1(14).Position(1)+test_px_1(12).Position(1))/2, ...
    (test_px_1(14).Position(2)+test_px_1(12).Position(2))/2; ...
    (test_px_1(13).Position(1)+test_px_1(11).Position(1))/2, ...
    (test_px_1(13).Position(2)+test_px_1(11).Position(2))/2; ...
    (test_px_1(3).Position(1)+test_px_1(4).Position(1))/2, ...
    (test_px_1(3).Position(2)+test_px_1(4).Position(2))/2; ...
    (test_px_1(12).Position(1)+test_px_1(11).Position(1))/2, ...
    (test_px_1(12).Position(2)+test_px_1(11).Position(2))/2; ...
    (test_px_1(1).Position(1)+test_px_1(2).Position(1))/2, ...
    (test_px_1(1).Position(2)+test_px_1(2).Position(2))/2; ...
    (test_px_1(10).Position(1)+test_px_1(8).Position(1))/2, ...
    (test_px_1(10).Position(2)+test_px_1(8).Position(2))/2; ...
    (test_px_1(9).Position(1)+test_px_1(7).Position(1))/2, ...
    (test_px_1(9).Position(2)+test_px_1(7).Position(2))/2; ...
    (test_px_1(8).Position(1)+test_px_1(7).Position(1))/2, ...
    (test_px_1(8).Position(2)+test_px_1(7).Position(2))/2];
imagePoints(:,:,2) = [test_px_2(17).Position(1),test_px_2(17).Position(2); ...
    test_px_2(16).Position(1),test_px_2(16).Position(2); ...
    test_px_2(15).Position(1),test_px_2(15).Position(2); ...
    test_px_2(14).Position(1),test_px_2(14).Position(2); ...
    test_px_2(13).Position(1),test_px_2(13).Position(2); ...    
    test_px_2(12).Position(1),test_px_2(12).Position(2); ...
    test_px_2(11).Position(1),test_px_2(11).Position(2); ...
    test_px_2(10).Position(1),test_px_2(10).Position(2); ...
    test_px_2(9).Position(1),test_px_2(9).Position(2); ...
    test_px_2(8).Position(1),test_px_2(8).Position(2); ...
    test_px_2(7).Position(1),test_px_2(7).Position(2); ...
    test_px_2(6).Position(1),test_px_2(6).Position(2); ...
    NaN,NaN; ...
    test_px_2(5).Position(1),test_px_2(5).Position(2); ...
    test_px_2(4).Position(1),test_px_2(4).Position(2); ...
    test_px_2(3).Position(1),test_px_2(3).Position(2); ...    
    test_px_2(2).Position(1),test_px_2(2).Position(2); ...
    test_px_2(1).Position(1),test_px_2(1).Position(2); ...
    NaN,NaN; ...
    (test_px_2(17).Position(1)+test_px_2(15).Position(1))/2, ...
    (test_px_2(17).Position(2)+test_px_2(15).Position(2))/2; ...
    (test_px_2(16).Position(1)+test_px_2(14).Position(1))/2, ...
    (test_px_2(16).Position(2)+test_px_2(14).Position(2))/2; ...
    (test_px_2(15).Position(1)+test_px_2(14).Position(1))/2, ...
    (test_px_2(15).Position(2)+test_px_2(14).Position(2))/2; ...
    (test_px_2(13).Position(1)+test_px_2(11).Position(1))/2, ...
    (test_px_2(13).Position(2)+test_px_2(11).Position(2))/2; ...
    (test_px_2(12).Position(1)+test_px_2(10).Position(1))/2, ...
    (test_px_2(12).Position(2)+test_px_2(10).Position(2))/2; ...
    (test_px_2(3).Position(1)+test_px_2(4).Position(1))/2, ...
    (test_px_2(3).Position(2)+test_px_2(4).Position(2))/2; ...
    (test_px_2(11).Position(1)+test_px_2(10).Position(1))/2, ...
    (test_px_2(11).Position(2)+test_px_2(10).Position(2))/2; ...
    (test_px_2(1).Position(1)+test_px_2(2).Position(1))/2, ...
    (test_px_2(1).Position(2)+test_px_2(2).Position(2))/2; ...
    (test_px_2(9).Position(1)+test_px_2(7).Position(1))/2, ...
    (test_px_2(9).Position(2)+test_px_2(7).Position(2))/2; ...
    (test_px_2(8).Position(1)+test_px_2(6).Position(1))/2, ...
    (test_px_2(8).Position(2)+test_px_2(6).Position(2))/2; ...
    (test_px_2(7).Position(1)+test_px_2(6).Position(1))/2, ...
    (test_px_2(7).Position(2)+test_px_2(6).Position(2))/2];
imagePoints(:,:,3) = [test_px_3(17).Position(1),test_px_3(17).Position(2); ...
    test_px_3(16).Position(1),test_px_3(16).Position(2); ...
    test_px_3(15).Position(1),test_px_3(15).Position(2); ...
    test_px_3(14).Position(1),test_px_3(14).Position(2); ...
    test_px_3(13).Position(1),test_px_3(13).Position(2); ...
    test_px_3(12).Position(1),test_px_3(12).Position(2); ...
    test_px_3(11).Position(1),test_px_3(11).Position(2); ...
    test_px_3(10).Position(1),test_px_3(10).Position(2); ...
    test_px_3(9).Position(1),test_px_3(9).Position(2); ...
    test_px_3(8).Position(1),test_px_3(8).Position(2); ...
    test_px_3(7).Position(1),test_px_3(7).Position(2); ...
    test_px_3(6).Position(1),test_px_3(6).Position(2); ...
    test_px_3(5).Position(1),test_px_3(5).Position(2); ...
    test_px_3(4).Position(1),test_px_3(4).Position(2); ...
    test_px_3(3).Position(1),test_px_3(3).Position(2); ...
    test_px_3(2).Position(1),test_px_3(2).Position(2); ...
    test_px_3(1).Position(1),test_px_3(1).Position(2); ...
    NaN,NaN; ...
    (test_px_3(4).Position(1)+test_px_3(5).Position(1))/2, ...
    (test_px_3(4).Position(2)+test_px_3(5).Position(2))/2; ...
    (test_px_3(17).Position(1)+test_px_3(15).Position(1))/2, ...
    (test_px_3(17).Position(2)+test_px_3(15).Position(2))/2; ...
    (test_px_3(16).Position(1)+test_px_3(14).Position(1))/2, ...
    (test_px_3(16).Position(2)+test_px_3(14).Position(2))/2; ...
    (test_px_3(15).Position(1)+test_px_3(14).Position(1))/2, ...
    (test_px_3(15).Position(2)+test_px_3(14).Position(2))/2; ...
    (test_px_3(13).Position(1)+test_px_3(11).Position(1))/2, ...
    (test_px_3(13).Position(2)+test_px_3(11).Position(2))/2; ...
    (test_px_3(12).Position(1)+test_px_3(10).Position(1))/2, ...
    (test_px_3(12).Position(2)+test_px_3(10).Position(2))/2; ...
    (test_px_3(2).Position(1)+test_px_3(3).Position(1))/2, ...
    (test_px_3(2).Position(2)+test_px_3(3).Position(2))/2; ...
    (test_px_3(11).Position(1)+test_px_3(10).Position(1))/2, ...
    (test_px_3(11).Position(2)+test_px_3(10).Position(2))/2; ...
    NaN,NaN; ...
    (test_px_3(9).Position(1)+test_px_3(7).Position(1))/2, ...
    (test_px_3(9).Position(2)+test_px_3(7).Position(2))/2; ...
    (test_px_3(8).Position(1)+test_px_3(6).Position(1))/2, ...
    (test_px_3(8).Position(2)+test_px_3(6).Position(2))/2; ...
    (test_px_3(7).Position(1)+test_px_3(6).Position(1))/2, ...
    (test_px_3(7).Position(2)+test_px_3(6).Position(2))/2];
imagePoints(:,:,4) = [test_px_4(16).Position(1),test_px_4(16).Position(2); ...
    NaN,NaN; ...
    test_px_4(15).Position(1),test_px_4(15).Position(2); ...    
    test_px_4(14).Position(1),test_px_4(14).Position(2); ...
    test_px_4(13).Position(1),test_px_4(13).Position(2); ...
    test_px_4(12).Position(1),test_px_4(12).Position(2); ...
    test_px_4(11).Position(1),test_px_4(11).Position(2); ...
    test_px_4(10).Position(1),test_px_4(10).Position(2); ...    
    test_px_4(9).Position(1),test_px_4(9).Position(2); ...
    test_px_4(8).Position(1),test_px_4(8).Position(2); ...
    test_px_4(7).Position(1),test_px_4(7).Position(2); ...
    test_px_4(6).Position(1),test_px_4(6).Position(2); ...
    NaN,NaN; ...
    test_px_4(5).Position(1),test_px_4(5).Position(2); ...
    test_px_4(4).Position(1),test_px_4(4).Position(2); ...
    test_px_4(3).Position(1),test_px_4(3).Position(2); ...
    test_px_4(2).Position(1),test_px_4(2).Position(2); ...
    test_px_4(1).Position(1),test_px_4(1).Position(2); ...
    NaN,NaN; ...
    (test_px_4(16).Position(1)+test_px_4(15).Position(1))/2, ...
    (test_px_4(16).Position(2)+test_px_4(15).Position(2))/2; ...
    NaN,NaN; ...
    (test_px_4(14).Position(1)+test_px_4(15).Position(1))/2, ...
    (test_px_4(14).Position(2)+test_px_4(15).Position(2))/2; ...
    (test_px_4(13).Position(1)+test_px_4(11).Position(1))/2, ...
    (test_px_4(13).Position(2)+test_px_4(11).Position(2))/2; ...
    (test_px_4(12).Position(1)+test_px_4(10).Position(1))/2, ...
    (test_px_4(12).Position(2)+test_px_4(10).Position(2))/2; ...
    (test_px_4(4).Position(1)+test_px_4(3).Position(1))/2, ...
    (test_px_4(4).Position(2)+test_px_4(3).Position(2))/2; ...
    (test_px_4(11).Position(1)+test_px_4(10).Position(1))/2, ...
    (test_px_4(11).Position(2)+test_px_4(10).Position(2))/2; ...
    (test_px_4(1).Position(1)+test_px_4(2).Position(1))/2, ...
    (test_px_4(1).Position(2)+test_px_4(2).Position(2))/2; ...
    (test_px_4(9).Position(1)+test_px_4(7).Position(1))/2, ...
    (test_px_4(9).Position(2)+test_px_4(7).Position(2))/2; ...
    (test_px_4(8).Position(1)+test_px_4(6).Position(1))/2, ...
    (test_px_4(8).Position(2)+test_px_4(6).Position(2))/2; ...
    (test_px_4(7).Position(1)+test_px_4(6).Position(1))/2, ...
    (test_px_4(7).Position(2)+test_px_4(6).Position(2))/2];
imagePoints(:,:,5) = [test_px_5(18).Position(1),test_px_5(18).Position(2); ...
    test_px_5(17).Position(1),test_px_5(17).Position(2); ...
    test_px_5(16).Position(1),test_px_5(16).Position(2); ...
    test_px_5(15).Position(1),test_px_5(15).Position(2); ...
    test_px_5(14).Position(1),test_px_5(14).Position(2); ...
    test_px_5(13).Position(1),test_px_5(13).Position(2); ...    
    test_px_5(12).Position(1),test_px_5(12).Position(2); ...
    test_px_5(11).Position(1),test_px_5(11).Position(2); ...
    test_px_5(10).Position(1),test_px_5(10).Position(2); ...
    test_px_5(9).Position(1),test_px_5(9).Position(2); ...
    test_px_5(8).Position(1),test_px_5(8).Position(2); ...
    test_px_5(7).Position(1),test_px_5(7).Position(2); ...
    test_px_5(6).Position(1),test_px_5(6).Position(2); ...
    test_px_5(5).Position(1),test_px_5(5).Position(2); ...
    test_px_5(4).Position(1),test_px_5(4).Position(2); ...
    test_px_5(3).Position(1),test_px_5(3).Position(2); ...    
    test_px_5(2).Position(1),test_px_5(2).Position(2); ...
    test_px_5(1).Position(1),test_px_5(1).Position(2); ...
    (test_px_5(5).Position(1)+test_px_5(6).Position(1))/2, ...
    (test_px_5(5).Position(2)+test_px_5(6).Position(2))/2; ...
    (test_px_5(18).Position(1)+test_px_5(16).Position(1))/2, ...
    (test_px_5(18).Position(2)+test_px_5(16).Position(2))/2; ...
    (test_px_5(17).Position(1)+test_px_5(15).Position(1))/2, ...
    (test_px_5(17).Position(2)+test_px_5(15).Position(2))/2; ...
    (test_px_5(16).Position(1)+test_px_5(15).Position(1))/2, ...
    (test_px_5(16).Position(2)+test_px_5(15).Position(2))/2; ...
    (test_px_5(14).Position(1)+test_px_5(12).Position(1))/2, ...
    (test_px_5(14).Position(2)+test_px_5(12).Position(2))/2; ...
    (test_px_5(13).Position(1)+test_px_5(11).Position(1))/2, ...
    (test_px_5(13).Position(2)+test_px_5(11).Position(2))/2; ...
    (test_px_5(3).Position(1)+test_px_5(4).Position(1))/2, ...
    (test_px_5(3).Position(2)+test_px_5(4).Position(2))/2; ...
    (test_px_5(12).Position(1)+test_px_5(11).Position(1))/2, ...
    (test_px_5(12).Position(2)+test_px_5(11).Position(2))/2; ...
    (test_px_5(1).Position(1)+test_px_5(2).Position(1))/2, ...
    (test_px_5(1).Position(2)+test_px_5(2).Position(2))/2; ...
    (test_px_5(10).Position(1)+test_px_5(8).Position(1))/2, ...
    (test_px_5(10).Position(2)+test_px_5(8).Position(2))/2; ...
    (test_px_5(9).Position(1)+test_px_5(7).Position(1))/2, ...
    (test_px_5(9).Position(2)+test_px_5(7).Position(2))/2; ...
    (test_px_5(8).Position(1)+test_px_5(7).Position(1))/2, ...
    (test_px_5(8).Position(2)+test_px_5(7).Position(2))/2];
imagePoints(:,:,6) = [test_px_6(18).Position(1),test_px_6(18).Position(2); ...
    test_px_6(17).Position(1),test_px_6(17).Position(2); ...
    test_px_6(16).Position(1),test_px_6(16).Position(2); ...
    test_px_6(15).Position(1),test_px_6(15).Position(2); ...
    test_px_6(14).Position(1),test_px_6(14).Position(2); ...
    test_px_6(13).Position(1),test_px_6(13).Position(2); ...    
    test_px_6(12).Position(1),test_px_6(12).Position(2); ...
    test_px_6(11).Position(1),test_px_6(11).Position(2); ...
    test_px_6(10).Position(1),test_px_6(10).Position(2); ...
    test_px_6(9).Position(1),test_px_6(9).Position(2); ...
    test_px_6(8).Position(1),test_px_6(8).Position(2); ...
    test_px_6(7).Position(1),test_px_6(7).Position(2); ...
    test_px_6(6).Position(1),test_px_6(6).Position(2); ...
    test_px_6(5).Position(1),test_px_6(5).Position(2); ...
    test_px_6(4).Position(1),test_px_6(4).Position(2); ...
    test_px_6(3).Position(1),test_px_6(3).Position(2); ...    
    test_px_6(2).Position(1),test_px_6(2).Position(2); ...
    test_px_6(1).Position(1),test_px_6(1).Position(2); ...
    (test_px_6(5).Position(1)+test_px_6(6).Position(1))/2, ...
    (test_px_6(5).Position(2)+test_px_6(6).Position(2))/2; ...
    (test_px_6(18).Position(1)+test_px_6(16).Position(1))/2, ...
    (test_px_6(18).Position(2)+test_px_6(16).Position(2))/2; ...
    (test_px_6(17).Position(1)+test_px_6(15).Position(1))/2, ...
    (test_px_6(17).Position(2)+test_px_6(15).Position(2))/2; ...
    (test_px_6(16).Position(1)+test_px_6(15).Position(1))/2, ...
    (test_px_6(16).Position(2)+test_px_6(15).Position(2))/2; ...
    (test_px_6(14).Position(1)+test_px_6(12).Position(1))/2, ...
    (test_px_6(14).Position(2)+test_px_6(12).Position(2))/2; ...
    (test_px_6(13).Position(1)+test_px_6(11).Position(1))/2, ...
    (test_px_6(13).Position(2)+test_px_6(11).Position(2))/2; ...
    (test_px_6(3).Position(1)+test_px_6(4).Position(1))/2, ...
    (test_px_6(3).Position(2)+test_px_6(4).Position(2))/2; ...
    (test_px_6(12).Position(1)+test_px_6(11).Position(1))/2, ...
    (test_px_6(12).Position(2)+test_px_6(11).Position(2))/2; ...
    (test_px_6(1).Position(1)+test_px_6(2).Position(1))/2, ...
    (test_px_6(1).Position(2)+test_px_6(2).Position(2))/2; ...
    (test_px_6(10).Position(1)+test_px_6(8).Position(1))/2, ...
    (test_px_6(10).Position(2)+test_px_6(8).Position(2))/2; ...
    (test_px_6(9).Position(1)+test_px_6(7).Position(1))/2, ...
    (test_px_6(9).Position(2)+test_px_6(7).Position(2))/2; ...
    (test_px_6(8).Position(1)+test_px_6(7).Position(1))/2, ...
    (test_px_6(8).Position(2)+test_px_6(7).Position(2))/2];
imagePoints(:,:,7) = [test_px_7(16).Position(1),test_px_7(16).Position(2); ...
    test_px_7(15).Position(1),test_px_7(15).Position(2); ...
    test_px_7(14).Position(1),test_px_7(14).Position(2);
    test_px_7(13).Position(1),test_px_7(13).Position(2); ...
    test_px_7(12).Position(1),test_px_7(12).Position(2); ...
    test_px_7(11).Position(1),test_px_7(11).Position(2); ...
    test_px_7(10).Position(1),test_px_7(10).Position(2); ...
    test_px_7(9).Position(1),test_px_7(9).Position(2); ...
    test_px_7(8).Position(1),test_px_7(8).Position(2);
    test_px_7(7).Position(1),test_px_7(7).Position(2); ...
    test_px_7(6).Position(1),test_px_7(6).Position(2); ...
    NaN,NaN; ...
    test_px_7(5).Position(1),test_px_7(5).Position(2); ...
    test_px_7(4).Position(1),test_px_7(4).Position(2); ...
    test_px_7(3).Position(1),test_px_7(3).Position(2); ...
    test_px_7(2).Position(1),test_px_7(2).Position(2); ...
    test_px_7(1).Position(1),test_px_7(1).Position(2); ...
    NaN,NaN; ...
    (test_px_7(5).Position(1)+test_px_7(4).Position(1))/2, ...
    (test_px_7(5).Position(2)+test_px_7(4).Position(2))/2; ...
    (test_px_7(16).Position(1)+test_px_7(14).Position(1))/2, ...
    (test_px_7(16).Position(2)+test_px_7(14).Position(2))/2; ...
    (test_px_7(15).Position(1)+test_px_7(13).Position(1))/2, ...
    (test_px_7(15).Position(2)+test_px_7(13).Position(2))/2; ...
    (test_px_7(14).Position(1)+test_px_7(13).Position(1))/2, ...
    (test_px_7(14).Position(2)+test_px_7(13).Position(2))/2; ...
    (test_px_7(12).Position(1)+test_px_7(10).Position(1))/2, ...
    (test_px_7(12).Position(2)+test_px_7(10).Position(2))/2; ...
    (test_px_7(11).Position(1)+test_px_7(9).Position(1))/2, ...
    (test_px_7(11).Position(2)+test_px_7(9).Position(2))/2; ...
    (test_px_7(2).Position(1)+test_px_7(3).Position(1))/2, ...
    (test_px_7(2).Position(2)+test_px_7(3).Position(2))/2; ...
    (test_px_7(10).Position(1)+test_px_7(9).Position(1))/2, ...
    (test_px_7(10).Position(2)+test_px_7(9).Position(2))/2; ...
    NaN,NaN; ...
    (test_px_7(8).Position(1)+test_px_7(6).Position(1))/2, ...
    (test_px_7(8).Position(2)+test_px_7(6).Position(2))/2; ...
    NaN,NaN; ...
    NaN,NaN];
imagePoints(:,:,8) = [test_px_8(17).Position(1),test_px_8(17).Position(2); ...
    test_px_8(16).Position(1),test_px_8(16).Position(2); ...
    test_px_8(15).Position(1),test_px_8(15).Position(2); ...
    test_px_8(14).Position(1),test_px_8(14).Position(2); ...
    test_px_8(13).Position(1),test_px_8(13).Position(2); ...
    test_px_8(12).Position(1),test_px_8(12).Position(2); ...
    test_px_8(11).Position(1),test_px_8(11).Position(2); ...
    test_px_8(10).Position(1),test_px_8(10).Position(2); ...
    test_px_8(9).Position(1),test_px_8(9).Position(2); ...
    test_px_8(8).Position(1),test_px_8(8).Position(2); ...
    test_px_8(7).Position(1),test_px_8(7).Position(2); ...
    test_px_8(6).Position(1),test_px_8(6).Position(2); ...
    NaN,NaN; ...
    test_px_8(5).Position(1),test_px_8(5).Position(2); ...
    test_px_8(4).Position(1),test_px_8(4).Position(2); ...
    test_px_8(3).Position(1),test_px_8(3).Position(2); ...
    test_px_8(2).Position(1),test_px_8(2).Position(2); ...
    test_px_8(1).Position(1),test_px_8(1).Position(2); ...
    NaN,NaN; ...
    (test_px_8(17).Position(1)+test_px_8(15).Position(1))/2, ...
    (test_px_8(17).Position(2)+test_px_8(15).Position(2))/2; ...
    (test_px_8(16).Position(1)+test_px_8(14).Position(1))/2, ...
    (test_px_8(16).Position(2)+test_px_8(14).Position(2))/2; ...
    (test_px_8(15).Position(1)+test_px_8(14).Position(1))/2, ...
    (test_px_8(15).Position(2)+test_px_8(14).Position(2))/2; ...
    (test_px_8(13).Position(1)+test_px_8(11).Position(1))/2, ...
    (test_px_8(13).Position(2)+test_px_8(11).Position(2))/2; ...
    (test_px_8(12).Position(1)+test_px_8(10).Position(1))/2, ...
    (test_px_8(12).Position(2)+test_px_8(10).Position(2))/2; ...
    (test_px_8(3).Position(1)+test_px_8(4).Position(1))/2, ...
    (test_px_8(3).Position(2)+test_px_8(4).Position(2))/2; ...
    (test_px_8(10).Position(1)+test_px_8(11).Position(1))/2, ...
    (test_px_8(10).Position(2)+test_px_8(11).Position(2))/2; ...
    (test_px_8(1).Position(1)+test_px_8(2).Position(1))/2, ...
    (test_px_8(1).Position(2)+test_px_8(2).Position(2))/2; ...
    (test_px_8(9).Position(1)+test_px_8(7).Position(1))/2, ...
    (test_px_8(9).Position(2)+test_px_8(7).Position(2))/2; ...
    (test_px_8(8).Position(1)+test_px_8(6).Position(1))/2, ...
    (test_px_8(8).Position(2)+test_px_8(6).Position(2))/2; ...
    (test_px_8(7).Position(1)+test_px_8(6).Position(1))/2, ...
    (test_px_8(7).Position(2)+test_px_8(6).Position(2))/2];
imagePoints(:,:,9) = [test_px_9(17).Position(1),test_px_9(17).Position(2); ...
    test_px_9(16).Position(1),test_px_9(16).Position(2); ...
    test_px_9(15).Position(1),test_px_9(15).Position(2); ...
    test_px_9(14).Position(1),test_px_9(14).Position(2); ...
    test_px_9(13).Position(1),test_px_9(13).Position(2); ...
    test_px_9(12).Position(1),test_px_9(12).Position(2); ...
    test_px_9(11).Position(1),test_px_9(11).Position(2); ...
    test_px_9(10).Position(1),test_px_9(10).Position(2); ...
    test_px_9(9).Position(1),test_px_9(9).Position(2); ...
    test_px_9(8).Position(1),test_px_9(8).Position(2); ...
    test_px_9(7).Position(1),test_px_9(7).Position(2); ...
    test_px_9(6).Position(1),test_px_9(6).Position(2); ...
    test_px_9(5).Position(1),test_px_9(5).Position(2); ...
    test_px_9(4).Position(1),test_px_9(4).Position(2); ...
    test_px_9(3).Position(1),test_px_9(3).Position(2); ...
    test_px_9(2).Position(1),test_px_9(2).Position(2); ...
    test_px_9(1).Position(1),test_px_9(1).Position(2); ...
    NaN,NaN; ...
    (test_px_9(5).Position(1)+test_px_9(4).Position(1))/2, ...
    (test_px_9(5).Position(2)+test_px_9(4).Position(2))/2; ...
    (test_px_9(17).Position(1)+test_px_9(15).Position(1))/2, ...
    (test_px_9(17).Position(2)+test_px_9(15).Position(2))/2; ...
    (test_px_9(16).Position(1)+test_px_9(14).Position(1))/2, ...
    (test_px_9(16).Position(2)+test_px_9(14).Position(2))/2; ...
    (test_px_9(15).Position(1)+test_px_9(14).Position(1))/2, ...
    (test_px_9(15).Position(2)+test_px_9(14).Position(2))/2; ...
    (test_px_9(13).Position(1)+test_px_9(11).Position(1))/2, ...
    (test_px_9(13).Position(2)+test_px_9(11).Position(2))/2; ...
    (test_px_9(12).Position(1)+test_px_9(10).Position(1))/2, ...
    (test_px_9(12).Position(2)+test_px_9(10).Position(2))/2; ...
    (test_px_9(2).Position(1)+test_px_9(3).Position(1))/2, ...
    (test_px_9(2).Position(2)+test_px_9(3).Position(2))/2; ...
    (test_px_9(11).Position(1)+test_px_9(10).Position(1))/2, ...
    (test_px_9(11).Position(2)+test_px_9(10).Position(2))/2; ...
    NaN,NaN; ...
    (test_px_9(9).Position(1)+test_px_9(7).Position(1))/2, ...
    (test_px_9(9).Position(2)+test_px_9(7).Position(2))/2; ...
    (test_px_9(8).Position(1)+test_px_9(6).Position(1))/2, ...
    (test_px_9(8).Position(2)+test_px_9(6).Position(2))/2; ...
    (test_px_9(7).Position(1)+test_px_9(6).Position(1))/2, ...
    (test_px_9(7).Position(2)+test_px_9(6).Position(2))/2];
imagePoints(:,:,10) = [test_px_10(18).Position(1),test_px_10(18).Position(2); ...
    test_px_10(17).Position(1),test_px_10(17).Position(2); ...
    test_px_10(16).Position(1),test_px_10(16).Position(2); ...
    test_px_10(15).Position(1),test_px_10(15).Position(2); ...
    test_px_10(14).Position(1),test_px_10(14).Position(2); ...
    test_px_10(13).Position(1),test_px_10(13).Position(2); ...    
    test_px_10(12).Position(1),test_px_10(12).Position(2); ...
    test_px_10(11).Position(1),test_px_10(11).Position(2); ...
    test_px_10(10).Position(1),test_px_10(10).Position(2); ...
    test_px_10(9).Position(1),test_px_10(9).Position(2); ...
    test_px_10(8).Position(1),test_px_10(8).Position(2); ...
    test_px_10(7).Position(1),test_px_10(7).Position(2); ...
    test_px_10(6).Position(1),test_px_10(6).Position(2); ...
    test_px_10(5).Position(1),test_px_10(5).Position(2); ...
    test_px_10(4).Position(1),test_px_10(4).Position(2); ...
    test_px_10(3).Position(1),test_px_10(3).Position(2); ...    
    test_px_10(2).Position(1),test_px_10(2).Position(2); ...
    test_px_10(1).Position(1),test_px_10(1).Position(2); ...
    (test_px_10(5).Position(1)+test_px_10(6).Position(1))/2, ...
    (test_px_10(5).Position(2)+test_px_10(6).Position(2))/2; ...
    (test_px_10(18).Position(1)+test_px_10(16).Position(1))/2, ...
    (test_px_10(18).Position(2)+test_px_10(16).Position(2))/2; ...
    (test_px_10(17).Position(1)+test_px_10(15).Position(1))/2, ...
    (test_px_10(17).Position(2)+test_px_10(15).Position(2))/2; ...
    (test_px_10(16).Position(1)+test_px_10(15).Position(1))/2, ...
    (test_px_10(16).Position(2)+test_px_10(15).Position(2))/2; ...
    (test_px_10(14).Position(1)+test_px_10(12).Position(1))/2, ...
    (test_px_10(14).Position(2)+test_px_10(12).Position(2))/2; ...
    (test_px_10(13).Position(1)+test_px_10(11).Position(1))/2, ...
    (test_px_10(13).Position(2)+test_px_10(11).Position(2))/2; ...
    (test_px_10(3).Position(1)+test_px_10(4).Position(1))/2, ...
    (test_px_10(3).Position(2)+test_px_10(4).Position(2))/2; ...
    (test_px_10(12).Position(1)+test_px_10(11).Position(1))/2, ...
    (test_px_10(12).Position(2)+test_px_10(11).Position(2))/2; ...
    (test_px_10(1).Position(1)+test_px_10(2).Position(1))/2, ...
    (test_px_10(1).Position(2)+test_px_10(2).Position(2))/2; ...
    (test_px_10(10).Position(1)+test_px_10(8).Position(1))/2, ...
    (test_px_10(10).Position(2)+test_px_10(8).Position(2))/2; ...
    (test_px_10(9).Position(1)+test_px_10(7).Position(1))/2, ...
    (test_px_10(9).Position(2)+test_px_10(7).Position(2))/2; ...
    (test_px_10(8).Position(1)+test_px_10(7).Position(1))/2, ...
    (test_px_10(8).Position(2)+test_px_10(7).Position(2))/2];
imagePoints(:,:,11) = [test_px_11(18).Position(1),test_px_11(18).Position(2); ...
    test_px_11(17).Position(1),test_px_11(17).Position(2); ...
    test_px_11(16).Position(1),test_px_11(16).Position(2); ...
    test_px_11(15).Position(1),test_px_11(15).Position(2); ...
    test_px_11(14).Position(1),test_px_11(14).Position(2); ...
    test_px_11(13).Position(1),test_px_11(13).Position(2); ...    
    test_px_11(12).Position(1),test_px_11(12).Position(2); ...
    test_px_11(11).Position(1),test_px_11(11).Position(2); ...
    test_px_11(10).Position(1),test_px_11(10).Position(2); ...
    test_px_11(9).Position(1),test_px_11(9).Position(2); ...
    test_px_11(8).Position(1),test_px_11(8).Position(2); ...
    test_px_11(7).Position(1),test_px_11(7).Position(2); ...
    test_px_11(6).Position(1),test_px_11(6).Position(2); ...
    test_px_11(5).Position(1),test_px_11(5).Position(2); ...
    test_px_11(4).Position(1),test_px_11(4).Position(2); ...
    test_px_11(3).Position(1),test_px_11(3).Position(2); ...    
    test_px_11(2).Position(1),test_px_11(2).Position(2); ...
    test_px_11(1).Position(1),test_px_11(1).Position(2); ...
    (test_px_11(5).Position(1)+test_px_11(6).Position(1))/2, ...
    (test_px_11(5).Position(2)+test_px_11(6).Position(2))/2; ...
    (test_px_11(18).Position(1)+test_px_11(16).Position(1))/2, ...
    (test_px_11(18).Position(2)+test_px_11(16).Position(2))/2; ...
    (test_px_11(17).Position(1)+test_px_11(15).Position(1))/2, ...
    (test_px_11(17).Position(2)+test_px_11(15).Position(2))/2; ...
    (test_px_11(16).Position(1)+test_px_11(15).Position(1))/2, ...
    (test_px_11(16).Position(2)+test_px_11(15).Position(2))/2; ...
    (test_px_11(14).Position(1)+test_px_11(12).Position(1))/2, ...
    (test_px_11(14).Position(2)+test_px_11(12).Position(2))/2; ...
    (test_px_11(13).Position(1)+test_px_11(11).Position(1))/2, ...
    (test_px_11(13).Position(2)+test_px_11(11).Position(2))/2; ...
    (test_px_11(3).Position(1)+test_px_11(4).Position(1))/2, ...
    (test_px_11(3).Position(2)+test_px_11(4).Position(2))/2; ...
    (test_px_11(12).Position(1)+test_px_11(11).Position(1))/2, ...
    (test_px_11(12).Position(2)+test_px_11(11).Position(2))/2; ...
    (test_px_11(1).Position(1)+test_px_11(2).Position(1))/2, ...
    (test_px_11(1).Position(2)+test_px_11(2).Position(2))/2; ...
    (test_px_11(10).Position(1)+test_px_11(8).Position(1))/2, ...
    (test_px_11(10).Position(2)+test_px_11(8).Position(2))/2; ...
    (test_px_11(9).Position(1)+test_px_11(7).Position(1))/2, ...
    (test_px_11(9).Position(2)+test_px_11(7).Position(2))/2; ...
    (test_px_11(8).Position(1)+test_px_11(7).Position(1))/2, ...
    (test_px_11(8).Position(2)+test_px_11(7).Position(2))/2];
imagePoints(:,:,12) = [test_px_12(18).Position(1),test_px_12(18).Position(2); ...
    test_px_12(17).Position(1),test_px_12(17).Position(2); ...
    test_px_12(16).Position(1),test_px_12(16).Position(2); ...
    test_px_12(15).Position(1),test_px_12(15).Position(2); ...
    test_px_12(14).Position(1),test_px_12(14).Position(2); ...
    test_px_12(13).Position(1),test_px_12(13).Position(2); ...    
    test_px_12(12).Position(1),test_px_12(12).Position(2); ...
    test_px_12(11).Position(1),test_px_12(11).Position(2); ...
    test_px_12(10).Position(1),test_px_12(10).Position(2); ...
    test_px_12(9).Position(1),test_px_12(9).Position(2); ...
    test_px_12(8).Position(1),test_px_12(8).Position(2); ...
    test_px_12(7).Position(1),test_px_12(7).Position(2); ...
    test_px_12(6).Position(1),test_px_12(6).Position(2); ...
    test_px_12(5).Position(1),test_px_12(5).Position(2); ...
    test_px_12(4).Position(1),test_px_12(4).Position(2); ...
    test_px_12(3).Position(1),test_px_12(3).Position(2); ...    
    test_px_12(2).Position(1),test_px_12(2).Position(2); ...
    test_px_12(1).Position(1),test_px_12(1).Position(2); ...
    (test_px_12(5).Position(1)+test_px_12(6).Position(1))/2, ...
    (test_px_12(5).Position(2)+test_px_12(6).Position(2))/2; ...
    (test_px_12(18).Position(1)+test_px_12(16).Position(1))/2, ...
    (test_px_12(18).Position(2)+test_px_12(16).Position(2))/2; ...
    (test_px_12(17).Position(1)+test_px_12(15).Position(1))/2, ...
    (test_px_12(17).Position(2)+test_px_12(15).Position(2))/2; ...
    (test_px_12(16).Position(1)+test_px_12(15).Position(1))/2, ...
    (test_px_12(16).Position(2)+test_px_12(15).Position(2))/2; ...
    (test_px_12(14).Position(1)+test_px_12(12).Position(1))/2, ...
    (test_px_12(14).Position(2)+test_px_12(12).Position(2))/2; ...
    (test_px_12(13).Position(1)+test_px_12(11).Position(1))/2, ...
    (test_px_12(13).Position(2)+test_px_12(11).Position(2))/2; ...
    (test_px_12(3).Position(1)+test_px_12(4).Position(1))/2, ...
    (test_px_12(3).Position(2)+test_px_12(4).Position(2))/2; ...
    (test_px_12(12).Position(1)+test_px_12(11).Position(1))/2, ...
    (test_px_12(12).Position(2)+test_px_12(11).Position(2))/2; ...
    (test_px_12(1).Position(1)+test_px_12(2).Position(1))/2, ...
    (test_px_12(1).Position(2)+test_px_12(2).Position(2))/2; ...
    (test_px_12(10).Position(1)+test_px_12(8).Position(1))/2, ...
    (test_px_12(10).Position(2)+test_px_12(8).Position(2))/2; ...
    (test_px_12(9).Position(1)+test_px_12(7).Position(1))/2, ...
    (test_px_12(9).Position(2)+test_px_12(7).Position(2))/2; ...
    (test_px_12(8).Position(1)+test_px_12(7).Position(1))/2, ...
    (test_px_12(8).Position(2)+test_px_12(7).Position(2))/2];
imagePoints(:,:,13) = [test_px_13(18).Position(1),test_px_13(18).Position(2); ...
    test_px_13(17).Position(1),test_px_13(17).Position(2); ...
    test_px_13(16).Position(1),test_px_13(16).Position(2); ...
    test_px_13(15).Position(1),test_px_13(15).Position(2); ...
    test_px_13(14).Position(1),test_px_13(14).Position(2); ...
    test_px_13(13).Position(1),test_px_13(13).Position(2); ...    
    test_px_13(12).Position(1),test_px_13(12).Position(2); ...
    test_px_13(11).Position(1),test_px_13(11).Position(2); ...
    test_px_13(10).Position(1),test_px_13(10).Position(2); ...
    test_px_13(9).Position(1),test_px_13(9).Position(2); ...
    test_px_13(8).Position(1),test_px_13(8).Position(2); ...
    test_px_13(7).Position(1),test_px_13(7).Position(2); ...
    test_px_13(6).Position(1),test_px_13(6).Position(2); ...
    test_px_13(5).Position(1),test_px_13(5).Position(2); ...
    test_px_13(4).Position(1),test_px_13(4).Position(2); ...
    test_px_13(3).Position(1),test_px_13(3).Position(2); ...    
    test_px_13(2).Position(1),test_px_13(2).Position(2); ...
    test_px_13(1).Position(1),test_px_13(1).Position(2); ...
    (test_px_13(5).Position(1)+test_px_13(6).Position(1))/2, ...
    (test_px_13(5).Position(2)+test_px_13(6).Position(2))/2; ...
    (test_px_13(18).Position(1)+test_px_13(16).Position(1))/2, ...
    (test_px_13(18).Position(2)+test_px_13(16).Position(2))/2; ...
    (test_px_13(17).Position(1)+test_px_13(15).Position(1))/2, ...
    (test_px_13(17).Position(2)+test_px_13(15).Position(2))/2; ...
    (test_px_13(16).Position(1)+test_px_13(15).Position(1))/2, ...
    (test_px_13(16).Position(2)+test_px_13(15).Position(2))/2; ...
    (test_px_13(14).Position(1)+test_px_13(12).Position(1))/2, ...
    (test_px_13(14).Position(2)+test_px_13(12).Position(2))/2; ...
    (test_px_13(13).Position(1)+test_px_13(11).Position(1))/2, ...
    (test_px_13(13).Position(2)+test_px_13(11).Position(2))/2; ...
    (test_px_13(3).Position(1)+test_px_13(4).Position(1))/2, ...
    (test_px_13(3).Position(2)+test_px_13(4).Position(2))/2; ...
    (test_px_13(12).Position(1)+test_px_13(11).Position(1))/2, ...
    (test_px_13(12).Position(2)+test_px_13(11).Position(2))/2; ...
    (test_px_13(1).Position(1)+test_px_13(2).Position(1))/2, ...
    (test_px_13(1).Position(2)+test_px_13(2).Position(2))/2; ...
    (test_px_13(10).Position(1)+test_px_13(8).Position(1))/2, ...
    (test_px_13(10).Position(2)+test_px_13(8).Position(2))/2; ...
    (test_px_13(9).Position(1)+test_px_13(7).Position(1))/2, ...
    (test_px_13(9).Position(2)+test_px_13(7).Position(2))/2; ...
    (test_px_13(8).Position(1)+test_px_13(7).Position(1))/2, ...
    (test_px_13(8).Position(2)+test_px_13(7).Position(2))/2];
imagePoints(:,:,14) = [test_px_14(17).Position(1),test_px_14(17).Position(2); ...
    test_px_14(16).Position(1),test_px_14(16).Position(2); ...
    test_px_14(15).Position(1),test_px_14(15).Position(2); ...
    test_px_14(14).Position(1),test_px_14(14).Position(2); ...
    test_px_14(13).Position(1),test_px_14(13).Position(2); ...
    test_px_14(12).Position(1),test_px_14(12).Position(2); ...
    test_px_14(11).Position(1),test_px_14(11).Position(2); ...
    test_px_14(10).Position(1),test_px_14(10).Position(2); ...
    test_px_14(9).Position(1),test_px_14(9).Position(2); ...
    test_px_14(8).Position(1),test_px_14(8).Position(2); ...
    test_px_14(7).Position(1),test_px_14(7).Position(2); ...
    test_px_14(6).Position(1),test_px_14(6).Position(2); ...
    NaN,NaN; ...
    test_px_14(5).Position(1),test_px_14(5).Position(2); ...
    test_px_14(4).Position(1),test_px_14(4).Position(2); ...
    test_px_14(3).Position(1),test_px_14(3).Position(2); ...
    test_px_14(2).Position(1),test_px_14(2).Position(2); ...
    test_px_14(1).Position(1),test_px_14(1).Position(2); ...
    NaN,NaN; ...
    (test_px_14(17).Position(1)+test_px_14(15).Position(1))/2, ...
    (test_px_14(17).Position(2)+test_px_14(15).Position(2))/2; ...
    (test_px_14(16).Position(1)+test_px_14(14).Position(1))/2, ...
    (test_px_14(16).Position(2)+test_px_14(14).Position(2))/2; ...
    (test_px_14(15).Position(1)+test_px_14(14).Position(1))/2, ...
    (test_px_14(15).Position(2)+test_px_14(14).Position(2))/2; ...
    (test_px_14(13).Position(1)+test_px_14(11).Position(1))/2, ...
    (test_px_14(13).Position(2)+test_px_14(11).Position(2))/2; ...
    (test_px_14(12).Position(1)+test_px_14(10).Position(1))/2, ...
    (test_px_14(12).Position(2)+test_px_14(10).Position(2))/2; ...
    (test_px_14(4).Position(1)+test_px_14(3).Position(1))/2, ...
    (test_px_14(4).Position(2)+test_px_14(3).Position(2))/2; ...
    (test_px_14(11).Position(1)+test_px_14(10).Position(1))/2, ...
    (test_px_14(11).Position(2)+test_px_14(10).Position(2))/2; ...
    (test_px_14(2).Position(1)+test_px_14(1).Position(1))/2, ...
    (test_px_14(2).Position(2)+test_px_14(1).Position(2))/2; ...
    (test_px_14(9).Position(1)+test_px_14(7).Position(1))/2, ...
    (test_px_14(9).Position(2)+test_px_14(7).Position(2))/2; ...
    (test_px_14(8).Position(1)+test_px_14(6).Position(1))/2, ...
    (test_px_14(8).Position(2)+test_px_14(6).Position(2))/2; ...
    (test_px_14(7).Position(1)+test_px_14(6).Position(1))/2, ...
    (test_px_14(7).Position(2)+test_px_14(6).Position(2))/2];
imagePoints(:,:,15) = [test_px_15(17).Position(1),test_px_15(17).Position(2); ...
    test_px_15(16).Position(1),test_px_15(16).Position(2); ...
    test_px_15(15).Position(1),test_px_15(15).Position(2); ...
    test_px_15(14).Position(1),test_px_15(14).Position(2); ...
    test_px_15(13).Position(1),test_px_15(13).Position(2); ...
    test_px_15(12).Position(1),test_px_15(12).Position(2); ...
    test_px_15(11).Position(1),test_px_15(11).Position(2); ...
    test_px_15(10).Position(1),test_px_15(10).Position(2); ...
    test_px_15(9).Position(1),test_px_15(9).Position(2); ...
    test_px_15(8).Position(1),test_px_15(8).Position(2); ...
    test_px_15(7).Position(1),test_px_15(7).Position(2); ...
    test_px_15(6).Position(1),test_px_15(6).Position(2); ...
    NaN,NaN; ...
    test_px_15(5).Position(1),test_px_15(5).Position(2); ...
    test_px_15(4).Position(1),test_px_15(4).Position(2); ...
    test_px_15(3).Position(1),test_px_15(3).Position(2); ...
    test_px_15(2).Position(1),test_px_15(2).Position(2); ...
    test_px_15(1).Position(1),test_px_15(1).Position(2); ...
    NaN,NaN; ...
    (test_px_15(17).Position(1)+test_px_15(15).Position(1))/2, ...
    (test_px_15(17).Position(2)+test_px_15(15).Position(2))/2; ...
    (test_px_15(16).Position(1)+test_px_15(14).Position(1))/2, ...
    (test_px_15(16).Position(2)+test_px_15(14).Position(2))/2; ...
    (test_px_15(15).Position(1)+test_px_15(14).Position(1))/2, ...
    (test_px_15(15).Position(2)+test_px_15(14).Position(2))/2; ...
    (test_px_15(13).Position(1)+test_px_15(11).Position(1))/2, ...
    (test_px_15(13).Position(2)+test_px_15(11).Position(2))/2; ...
    (test_px_15(12).Position(1)+test_px_15(10).Position(1))/2, ...
    (test_px_15(12).Position(2)+test_px_15(10).Position(2))/2; ...
    (test_px_15(3).Position(1)+test_px_15(4).Position(1))/2, ...
    (test_px_15(3).Position(2)+test_px_15(4).Position(2))/2; ...
    (test_px_15(10).Position(1)+test_px_15(11).Position(1))/2, ...
    (test_px_15(10).Position(2)+test_px_15(11).Position(2))/2; ...
    (test_px_15(1).Position(1)+test_px_15(2).Position(1))/2, ...
    (test_px_15(1).Position(2)+test_px_15(2).Position(2))/2; ...
    (test_px_15(9).Position(1)+test_px_15(7).Position(1))/2, ...
    (test_px_15(9).Position(2)+test_px_15(7).Position(2))/2; ...
    (test_px_15(8).Position(1)+test_px_15(6).Position(1))/2, ...
    (test_px_15(8).Position(2)+test_px_15(6).Position(2))/2; ...
    (test_px_15(7).Position(1)+test_px_15(6).Position(1))/2, ...
    (test_px_15(7).Position(2)+test_px_15(6).Position(2))/2];
imagePoints(:,:,16) = [test_px_16(18).Position(1),test_px_16(18).Position(2); ...
    test_px_16(17).Position(1),test_px_16(17).Position(2); ...
    test_px_16(16).Position(1),test_px_16(16).Position(2); ...
    test_px_16(15).Position(1),test_px_16(15).Position(2); ...
    test_px_16(14).Position(1),test_px_16(14).Position(2); ...
    test_px_16(13).Position(1),test_px_16(13).Position(2); ...    
    test_px_16(12).Position(1),test_px_16(12).Position(2); ...
    test_px_16(11).Position(1),test_px_16(11).Position(2); ...
    test_px_16(10).Position(1),test_px_16(10).Position(2); ...
    test_px_16(9).Position(1),test_px_16(9).Position(2); ...
    test_px_16(8).Position(1),test_px_16(8).Position(2); ...
    test_px_16(7).Position(1),test_px_16(7).Position(2); ...
    test_px_16(6).Position(1),test_px_16(6).Position(2); ...
    test_px_16(5).Position(1),test_px_16(5).Position(2); ...
    test_px_16(4).Position(1),test_px_16(4).Position(2); ...
    test_px_16(3).Position(1),test_px_16(3).Position(2); ...    
    test_px_16(2).Position(1),test_px_16(2).Position(2); ...
    test_px_16(1).Position(1),test_px_16(1).Position(2); ...
    (test_px_16(5).Position(1)+test_px_16(6).Position(1))/2, ...
    (test_px_16(5).Position(2)+test_px_16(6).Position(2))/2; ...
    (test_px_16(18).Position(1)+test_px_16(16).Position(1))/2, ...
    (test_px_16(18).Position(2)+test_px_16(16).Position(2))/2; ...
    (test_px_16(17).Position(1)+test_px_16(15).Position(1))/2, ...
    (test_px_16(17).Position(2)+test_px_16(15).Position(2))/2; ...
    (test_px_16(16).Position(1)+test_px_16(15).Position(1))/2, ...
    (test_px_16(16).Position(2)+test_px_16(15).Position(2))/2; ...
    (test_px_16(14).Position(1)+test_px_16(12).Position(1))/2, ...
    (test_px_16(14).Position(2)+test_px_16(12).Position(2))/2; ...
    (test_px_16(13).Position(1)+test_px_16(11).Position(1))/2, ...
    (test_px_16(13).Position(2)+test_px_16(11).Position(2))/2; ...
    (test_px_16(3).Position(1)+test_px_16(4).Position(1))/2, ...
    (test_px_16(3).Position(2)+test_px_16(4).Position(2))/2; ...
    (test_px_16(12).Position(1)+test_px_16(11).Position(1))/2, ...
    (test_px_16(12).Position(2)+test_px_16(11).Position(2))/2; ...
    (test_px_16(1).Position(1)+test_px_16(2).Position(1))/2, ...
    (test_px_16(1).Position(2)+test_px_16(2).Position(2))/2; ...
    (test_px_16(10).Position(1)+test_px_16(8).Position(1))/2, ...
    (test_px_16(10).Position(2)+test_px_16(8).Position(2))/2; ...
    (test_px_16(9).Position(1)+test_px_16(7).Position(1))/2, ...
    (test_px_16(9).Position(2)+test_px_16(7).Position(2))/2; ...
    (test_px_16(8).Position(1)+test_px_16(7).Position(1))/2, ...
    (test_px_16(8).Position(2)+test_px_16(7).Position(2))/2];

%% Create image pixel struct

% Create a pixel storage struct for the following imagePoints() 3D matrix
% creation

% Define number of pixels and images
NOPX  = 30;
NOIMG = 16;

% Define a struct that for every image defines if it has to be included or
% not in the calibration and its pixels to be used
for i = 1:NOIMG

    % Define a struct that for every pixel defines if it has to be included or
    % not in the calibration
    for j = 1:NOPX
        pixel_values(j).Include = 'T';
        pixel_values(j).Values = imagePoints(j,:,i);
    end

    img_struct(i).Include = 'T';
    img_struct(i).Pixels = pixel_values;
end

save([data_dir,'img_struct.mat'],'img_struct');

%% Geodetic coordinates extraction

O = kml2struct([kml_data_dir, 'Origine traguardo.kml']);
grid  = kml2struct([kml_data_dir, 'grid.kml']);
grid_test5  = kml2struct([kml_data_dir, 'grid_test5.kml']);
grid_test8  = kml2struct([kml_data_dir, 'grid_test8.kml']);
kerb = kml2struct([kml_data_dir, 'keypoints cordolo def.kml']);
origin = [O.Lat, O.Lon, O.Alt];

% origin = [45.629828413016030, 9.291562998765919, 190.8882878615457];

%% World points struct

ref = [grid(5).Lat,grid(5).Lon,grid(5).Alt];

for i=1:NOPX
    world_pts_struct(i).Include = 'T';

    if i <=18
        [local1,local2]=latlon2local(grid(i).Lat,grid(i).Lon,grid(i).Alt,ref);
        world_pts_struct(i).Value(1) = local1;
        world_pts_struct(i).Value(2) = local2;
    elseif i==19
        world_pts_struct(i).Value(1) = (world_pts_struct(13).Value(1)+world_pts_struct(14).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(13).Value(2)+world_pts_struct(14).Value(2))/2;
    elseif i==20
        world_pts_struct(i).Value(1) = (world_pts_struct(1).Value(1)+world_pts_struct(3).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(1).Value(2)+world_pts_struct(3).Value(2))/2;
    elseif i==21
        world_pts_struct(i).Value(1) = (world_pts_struct(2).Value(1)+world_pts_struct(4).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(2).Value(2)+world_pts_struct(4).Value(2))/2;
    elseif i==22
        world_pts_struct(i).Value(1) = (world_pts_struct(3).Value(1)+world_pts_struct(4).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(3).Value(2)+world_pts_struct(4).Value(2))/2;
    elseif i==23
        world_pts_struct(i).Value(1) = (world_pts_struct(5).Value(1)+world_pts_struct(7).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(5).Value(2)+world_pts_struct(7).Value(2))/2;
    elseif i==24
        world_pts_struct(i).Value(1) = (world_pts_struct(8).Value(1)+world_pts_struct(6).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(8).Value(2)+world_pts_struct(6).Value(2))/2;
    elseif i==25
        world_pts_struct(i).Value(1) = (world_pts_struct(15).Value(1)+world_pts_struct(16).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(15).Value(2)+world_pts_struct(16).Value(2))/2;
    elseif i==26
        world_pts_struct(i).Value(1) = (world_pts_struct(7).Value(1)+world_pts_struct(8).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(7).Value(2)+world_pts_struct(8).Value(2))/2;
    elseif i==27
        world_pts_struct(i).Value(1) = (world_pts_struct(17).Value(1)+world_pts_struct(18).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(17).Value(2)+world_pts_struct(18).Value(2))/2;
    elseif i==28
        world_pts_struct(i).Value(1) = (world_pts_struct(11).Value(1)+world_pts_struct(9).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(11).Value(2)+world_pts_struct(9).Value(2))/2;
    elseif i==29
        world_pts_struct(i).Value(1) = (world_pts_struct(10).Value(1)+world_pts_struct(12).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(10).Value(2)+world_pts_struct(12).Value(2))/2;
    elseif i==30
        world_pts_struct(i).Value(1) = (world_pts_struct(11).Value(1)+world_pts_struct(12).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(11).Value(2)+world_pts_struct(12).Value(2))/2;
    end
end

save([data_dir,'world_pts_struct.mat'],'world_pts_struct');

%% Worldpoints creation

NOTRUE = 0;

for i=1:NOPX
    if world_pts_struct(i).Include
        NOTRUE = NOTRUE + 1;
    end
end

for i=1:NOTRUE
    for j=1:2
        worldPoints(i,j) = world_pts_struct(i).Value(j);
    end
end

%%

figure()
plot( [worldPoints(:,1)],[worldPoints(:,2)],'*');
axis equal
% plot(p5_1x,p5_1y,'go');
axis equal

%% Extrinsic parameters extraction

ref = [grid_test5(5).Lat,grid_test5(5).Lon,grid_test5(5).Alt];

for i=1:NOPX
    world_pts_struct(i).Include = 'T';

    if i <=18
        [local1,local2]=latlon2local(grid_test5(i).Lat,grid_test5(i).Lon,grid_test5(i).Alt,ref);
        world_pts_struct(i).Value(1) = local1;
        world_pts_struct(i).Value(2) = local2;
    elseif i==19
        world_pts_struct(i).Value(1) = (world_pts_struct(13).Value(1)+world_pts_struct(14).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(13).Value(2)+world_pts_struct(14).Value(2))/2;
    elseif i==20
        world_pts_struct(i).Value(1) = (world_pts_struct(1).Value(1)+world_pts_struct(3).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(1).Value(2)+world_pts_struct(3).Value(2))/2;
    elseif i==21
        world_pts_struct(i).Value(1) = (world_pts_struct(2).Value(1)+world_pts_struct(4).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(2).Value(2)+world_pts_struct(4).Value(2))/2;
    elseif i==22
        world_pts_struct(i).Value(1) = (world_pts_struct(3).Value(1)+world_pts_struct(4).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(3).Value(2)+world_pts_struct(4).Value(2))/2;
    elseif i==23
        world_pts_struct(i).Value(1) = (world_pts_struct(5).Value(1)+world_pts_struct(7).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(5).Value(2)+world_pts_struct(7).Value(2))/2;
    elseif i==24
        world_pts_struct(i).Value(1) = (world_pts_struct(8).Value(1)+world_pts_struct(6).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(8).Value(2)+world_pts_struct(6).Value(2))/2;
    elseif i==25
        world_pts_struct(i).Value(1) = (world_pts_struct(15).Value(1)+world_pts_struct(16).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(15).Value(2)+world_pts_struct(16).Value(2))/2;
    elseif i==26
        world_pts_struct(i).Value(1) = (world_pts_struct(7).Value(1)+world_pts_struct(8).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(7).Value(2)+world_pts_struct(8).Value(2))/2;
    elseif i==27
        world_pts_struct(i).Value(1) = (world_pts_struct(17).Value(1)+world_pts_struct(18).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(17).Value(2)+world_pts_struct(18).Value(2))/2;
    elseif i==28
        world_pts_struct(i).Value(1) = (world_pts_struct(11).Value(1)+world_pts_struct(9).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(11).Value(2)+world_pts_struct(9).Value(2))/2;
    elseif i==29
        world_pts_struct(i).Value(1) = (world_pts_struct(10).Value(1)+world_pts_struct(12).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(10).Value(2)+world_pts_struct(12).Value(2))/2;
    elseif i==30
        world_pts_struct(i).Value(1) = (world_pts_struct(11).Value(1)+world_pts_struct(12).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(11).Value(2)+world_pts_struct(12).Value(2))/2;
    end
end

world_pts_struct_t5 = world_pts_struct;

save([data_dir,'world_pts_struct_t5.mat'],'world_pts_struct_t5');

%% Extrinsic parameters extraction

ref = [grid_test8(5).Lat,grid_test8(5).Lon,grid_test8(5).Alt];

for i=1:NOPX
    world_pts_struct(i).Include = 'T';

    if i <=18
        [local1,local2]=latlon2local(grid_test8(i).Lat,grid_test8(i).Lon,grid_test8(i).Alt,ref);
        world_pts_struct(i).Value(1) = local1;
        world_pts_struct(i).Value(2) = local2;
    elseif i==19
        world_pts_struct(i).Value(1) = (world_pts_struct(13).Value(1)+world_pts_struct(14).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(13).Value(2)+world_pts_struct(14).Value(2))/2;
    elseif i==20
        world_pts_struct(i).Value(1) = (world_pts_struct(1).Value(1)+world_pts_struct(3).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(1).Value(2)+world_pts_struct(3).Value(2))/2;
    elseif i==21
        world_pts_struct(i).Value(1) = (world_pts_struct(2).Value(1)+world_pts_struct(4).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(2).Value(2)+world_pts_struct(4).Value(2))/2;
    elseif i==22
        world_pts_struct(i).Value(1) = (world_pts_struct(3).Value(1)+world_pts_struct(4).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(3).Value(2)+world_pts_struct(4).Value(2))/2;
    elseif i==23
        world_pts_struct(i).Value(1) = (world_pts_struct(5).Value(1)+world_pts_struct(7).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(5).Value(2)+world_pts_struct(7).Value(2))/2;
    elseif i==24
        world_pts_struct(i).Value(1) = (world_pts_struct(8).Value(1)+world_pts_struct(6).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(8).Value(2)+world_pts_struct(6).Value(2))/2;
    elseif i==25
        world_pts_struct(i).Value(1) = (world_pts_struct(15).Value(1)+world_pts_struct(16).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(15).Value(2)+world_pts_struct(16).Value(2))/2;
    elseif i==26
        world_pts_struct(i).Value(1) = (world_pts_struct(7).Value(1)+world_pts_struct(8).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(7).Value(2)+world_pts_struct(8).Value(2))/2;
    elseif i==27
        world_pts_struct(i).Value(1) = (world_pts_struct(17).Value(1)+world_pts_struct(18).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(17).Value(2)+world_pts_struct(18).Value(2))/2;
    elseif i==28
        world_pts_struct(i).Value(1) = (world_pts_struct(11).Value(1)+world_pts_struct(9).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(11).Value(2)+world_pts_struct(9).Value(2))/2;
    elseif i==29
        world_pts_struct(i).Value(1) = (world_pts_struct(10).Value(1)+world_pts_struct(12).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(10).Value(2)+world_pts_struct(12).Value(2))/2;
    elseif i==30
        world_pts_struct(i).Value(1) = (world_pts_struct(11).Value(1)+world_pts_struct(12).Value(1))/2;
        world_pts_struct(i).Value(2) = (world_pts_struct(11).Value(2)+world_pts_struct(12).Value(2))/2;
    end
end

world_pts_struct_t8 = world_pts_struct;

save([data_dir,'world_pts_struct_t8.mat'],'world_pts_struct_t8');

%% Kerb test

% Extract the data of a different element

% Image points

kerb_pixels = load('../../experimental-data/Images for calibration/estimateCP method dataset/3 and 2 starting positions/test1_kerb.mat').test1_pixels;

NOPX_k  = 12;

cnt = 0;

imagePoints_k = zeros(length(kerb_pixels),2,1);

for i=1:length(kerb_pixels)
    imagePoints_k(i,1,1) = kerb_pixels(length(kerb_pixels)-cnt).Position(1);
    imagePoints_k(i,2,1) = kerb_pixels(length(kerb_pixels)-cnt).Position(2);
    cnt = cnt + 1;
end

% Define a struct that for every pixel defines if it has to be included or
% not in the calibration
for j = 1:NOPX_k
    if j < 9
        pixel_values_k(j).Include = 'T';
        pixel_values_k(j).Values = imagePoints_k(j,:,1);
    elseif j == 9
        pixel_values_k(j).Include = 'T';
        pixel_values_k(j).Values(1) = (imagePoints_k(1,1,1)+imagePoints_k(2,1,1))/2;
        pixel_values_k(j).Values(2) = (imagePoints_k(1,2,1)+imagePoints_k(2,2,1))/2;
    elseif j == 10
        pixel_values_k(j).Include = 'T';
        pixel_values_k(j).Values(1) = (imagePoints_k(3,1,1)+imagePoints_k(4,1,1))/2;
        pixel_values_k(j).Values(2) = (imagePoints_k(3,2,1)+imagePoints_k(4,2,1))/2;
    elseif j == 11
        pixel_values_k(j).Include = 'T';
        pixel_values_k(j).Values(1) = (imagePoints_k(5,1,1)+imagePoints_k(6,1,1))/2;
        pixel_values_k(j).Values(2) = (imagePoints_k(5,2,1)+imagePoints_k(6,2,1))/2;
    elseif j == 12
        pixel_values_k(j).Include = 'T';
        pixel_values_k(j).Values(1) = (imagePoints_k(7,1,1)+imagePoints_k(8,1,1))/2;
        pixel_values_k(j).Values(2) = (imagePoints_k(7,2,1)+imagePoints_k(8,2,1))/2;
    end
end

save([data_dir,'img_struct_k.mat'],'pixel_values_k');


% World Points

ref = [kerb(5).Lat,kerb(5).Lon,kerb(5).Alt];

for i=1:12
    world_pts_kerb(i).Include = 'T';

    if i < 9
        [local1,local2]=latlon2local(kerb(i).Lat,kerb(i).Lon,kerb(i).Alt,ref);
        world_pts_kerb(i).Value(1) = local1;
        world_pts_kerb(i).Value(2) = local2;
    elseif i==9
        world_pts_kerb(i).Value(1) = (world_pts_kerb(1).Value(1)+world_pts_kerb(2).Value(1))/2;
        world_pts_kerb(i).Value(2) = (world_pts_kerb(1).Value(2)+world_pts_kerb(2).Value(2))/2;
    elseif i==10
        world_pts_kerb(i).Value(1) = (world_pts_kerb(3).Value(1)+world_pts_kerb(4).Value(1))/2;
        world_pts_kerb(i).Value(2) = (world_pts_kerb(3).Value(2)+world_pts_kerb(4).Value(2))/2;
    elseif i==11
        world_pts_kerb(i).Value(1) = (world_pts_kerb(5).Value(1)+world_pts_kerb(6).Value(1))/2;
        world_pts_kerb(i).Value(2) = (world_pts_kerb(5).Value(2)+world_pts_kerb(6).Value(2))/2;
    elseif i==12
        world_pts_kerb(i).Value(1) = (world_pts_kerb(7).Value(1)+world_pts_kerb(8).Value(1))/2;
        world_pts_kerb(i).Value(2) = (world_pts_kerb(7).Value(2)+world_pts_kerb(8).Value(2))/2;

    end
end

save([data_dir,'world_pts_struct_kerb.mat'],'world_pts_kerb');
